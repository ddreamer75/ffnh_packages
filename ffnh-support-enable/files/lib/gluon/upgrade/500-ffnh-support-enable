local uci   = require("uci").cursor()
local site  = require("gluon.site_config")

local support_keys = site.support and site.support.ssh and site.support.ssh.keys or {}

uci:load("gluon-config-mode")
local enabled = uci:get_bool("gluon-config-mode", "support_enabled")
uci:unload("gluon-config-mode")

if not enabled then
  return
end

print("Synchronizing Freifunk Nordhessen Support SSH Keysâ€¦")

local file = "/etc/dropbear/authorized_keys"
local f = io.open(file, "r")
local content = f and f:read("*all") or ""
if f then f:close() end

local new_output = {}

local function is_support_key(line)
  for _, k in ipairs(support_keys) do
    if line == k then return true end
  end
  return false
end

for line in content:gmatch("[^
]+") do
  if not is_support_key(line) then
    new_output[#new_output + 1] = line
  end
end

for _, key in ipairs(support_keys) do
  new_output[#new_output + 1] = key
end

local w = io.open(file, "w")
w:write(table.concat(new_output, "
") .. "
")
w:close()
